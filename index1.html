<!DOCTYPE html>
<html>
  <head>
	<meta charset="UTF-8">
	<title>Hello World!</title>
  </head>
  <body>
<script>

global.startTime = Date.now();

const vm = require('vm');
const fs = require('fs');
const path = require('path');

const bundleFilename = path.join(__dirname, 'tmp/bundle.js');
const bundleCachedData = path.join(__dirname, 'tmp/bundle-cached-data');

const nodeRequire = require;

// Load the code via `vm`, with cached data
(function() {
	let previousCachedData = null;
	try { previousCachedData = fs.readFileSync(bundleCachedData) } catch(err) {}

	const options = { filename: bundleFilename };
	if (previousCachedData) {
		options.cachedData = previousCachedData;
	} else {
		options.produceCachedData = true;
	}

	const script = new vm.Script(fs.readFileSync(bundleFilename), options);

	if (previousCachedData) {
		if (script.cachedDataRejected) {
			console.error('!! cachedDataRejected, will delete it now, please run again!');
			try { fs.unlinkSync(bundleCachedData); } catch(err) {}
		} else {
			console.log('cachedData accepted! :)');
		}
	} else {
		fs.writeFileSync(bundleCachedData, script.cachedData);
		console.warn('!! cachedData generated, please run again!');
	}

	script.runInThisContext(options);
	var amdDefine = global.define;
	var amdRequire = global.require;
	global.define = undefined;

	nodeRequire('./benchmark').benchmark(nodeRequire, amdRequire);
}).call(this);

</script>
  </body>
</html>
